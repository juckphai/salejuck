
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>บัญชีขาย</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="บัญชีขาย">
    <link rel="apple-touch-icon" href="./192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        .online-status {
            width: 10px;
            height: 10px;
            background-color: #ccc; /* สีเทา = ออฟไลน์ */
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            box-shadow: 0 0 2px #000;
        }
        .online-status.active {
            background-color: #00ff00; /* สีเขียว = ออนไลน์ */
            box-shadow: 0 0 5px #00ff00;
        }
        .online-status.error {
            background-color: #ff0000; /* สีแดง = หลุด */
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div id="login-screen">
            <h1>บัญชีขาย</h1>
            <p>กรุณาเข้าสู่ระบบเพื่อดำเนินการต่อ</p>
            <form id="login-form">
                <label for="username">ชื่อผู้ใช้:</label>
                <input type="text" id="username" required>
                
                <label for="password">รหัสผ่าน:</label>
                <input type="password" id="password" required>
                
                <div class="checkbox-group">
                    <label for="show-password-login">
                        <input type="checkbox" id="show-password-login">
                        แสดงรหัสผ่าน
                    </label>
                </div>
                
                <div class="checkbox-group">
                    <label for="remember-me">
                        <input type="checkbox" id="remember-me">
                        จดจำการเข้าสู่ระบบ
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="success">เข้าสู่ระบบ</button>
                </div>
            </form>
            <p id="login-error" style="color: var(--danger-color);"></p>
        </div>

        <div id="main-app">
            <div class="top-bar">
                <h1 style="font-size: 16px; font-style: normal;">
                    บัญชีขาย <span id="store-display-name" style="color: #FFD700; font-style: normal;"></span>
                    <span id="connection-status" class="online-status" title="สถานะการเชื่อมต่อ"></span>
                </h1>
                <div id="user-info-container">
                    <span id="user-info"></span>
                    <button id="logout-btn">ออกจากระบบ</button>
                </div>
            </div>

            <div class="section-header header-pos" onclick="App.showPage('page-pos')">
                <span>ขายสินค้า (POS)</span><span class="arrow">▶</span>
            </div>
            <div id="page-pos" class="section-content"></div>

            <div class="section-header header-products admin-only" onclick="App.showPage('page-products')">
                <span>จัดการสินค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-products" class="section-content admin-only"></div>

            <div class="section-header header-stock admin-only" onclick="App.showPage('page-stock-in')">
                <span>นำเข้าสินค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-stock-in" class="section-content admin-only"></div>

            <div class="section-header header-stock-out admin-only" onclick="App.showPage('page-stock-out')">
                <span>ปรับสต็อก (นำออก)</span><span class="arrow">▶</span>
            </div>
            <div id="page-stock-out" class="section-content admin-only"></div>

            <div class="section-header header-history admin-only" onclick="App.showPage('page-sales-history')">
                <span>รายการขายย้อนหลัง</span><span class="arrow">▶</span>
            </div>
            <div id="page-sales-history" class="section-content admin-only"></div>

            <div class="section-header header-reports admin-only" onclick="App.showPage('page-reports')">
                <span>รายงานกำไร/ขาดทุน</span><span class="arrow">▶</span>
            </div>
            <div id="page-reports" class="section-content admin-only"></div>

            <div class="section-header header-summary admin-only" onclick="App.showPage('page-summary')">
                <span>สรุปข้อมูล</span><span class="arrow">▶</span>
            </div>
            <div id="page-summary" class="section-content admin-only"></div>
            
            <div class="section-header header-stores admin-only" onclick="App.showPage('page-stores')">
                <span>จัดการร้านค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-stores" class="section-content admin-only"></div>

            <div class="section-header header-users admin-only" onclick="App.showPage('page-users')">
                <span>จัดการผู้ใช้</span><span class="arrow">▶</span>
            </div>
            <div id="page-users" class="section-content admin-only"></div>

            <div class="section-header header-data" onclick="App.showPage('page-data')">
                <span>จัดการข้อมูล</span><span class="arrow">▶</span>
            </div>
            <div id="page-data" class="section-content"></div>
        </div>
    </div>

    <div id="toast-notification"></div>
    <div id="summaryModal" class="modal-overlay">
        <div class="modal-content-container">
            <div id="modalBodyContent"></div>
            <div class="modal-controls">
                <button id="saveSummaryAsImageBtn" class="modal-close-btn" style="background-color: #007bff; margin-bottom: 15px;">บันทึกเป็นรูปภาพ</button>
                <div class="control-group">
                    <label for="summaryFontSizeSlider">ปรับขนาดตัวอักษร:</label>
                    <input type="range" id="summaryFontSizeSlider" min="0.5" max="1.5" step="0.05" value="1.0">
                    <span id="summaryFontSizeValue">ขนาด: 100%</span>
                </div>
                <div class="control-group">
                    <label for="summaryLineHeightSlider">ปรับขนาดของบรรทัด:</label>
                    <input type="range" id="summaryLineHeightSlider" min="0.1" max="2.5" step="0.01" value="1.0">
                    <span id="summaryLineHeightValue">ความสูงของบรรทัด: 1.0</span>
                </div>
                <button onclick="App.closeSummaryModal()" class="modal-close-btn">ปิดหน้าต่างนี้</button>
            </div>
        </div>
    </div>

    <div id="summaryOutputModal" class="modal-overlay">
        <div class="format-modal-content">
            <h3>เลือกรูปแบบการแสดงผลสรุป</h3>
            <div class="format-modal-buttons">
                <button class="btn-display" onclick="App.handleSummaryOutput('display')">แสดงบนจอ</button>
                <button class="btn-excel" onclick="App.handleSummaryOutput('excel')">ส่งออกเป็น Excel</button>
                <button class="btn-pdf" onclick="App.handleSummaryOutput('pdf')">บันทึกเป็น PDF</button>
                <button class="btn-cancel" onclick="App.closeSummaryOutputModal()">ยกเลิก</button>
            </div>
        </div>
    </div>
    
    <div id="resetModal" class="modal-overlay">
        <div id="reset-modal-content">
            <h3>เลือกข้อมูลที่จะรีเซ็ต</h3>
            <p style="color: var(--danger-color); font-weight: bold;">คำเตือน: การกระทำนี้ไม่สามารถย้อนกลับได้! โปรดเลือกด้วยความระมัดระวัง</p>
            <div id="reset-options-container">
                <label><input type="checkbox" id="reset-sales-checkbox"> ลบประวัติการขายทั้งหมด (Sales)</label>
                <label><input type="checkbox" id="reset-stockins-checkbox"> ลบประวัติการนำเข้าทั้งหมด (Stock-ins)</label>
                <label><input type="checkbox" id="reset-products-checkbox"> ลบสินค้าทั้งหมด (Products)</label>
                <label style="color: var(--danger-color);"><input type="checkbox" id="reset-sellers-checkbox"> ลบผู้ขายทั้งหมด (Sellers - ยกเว้น Admin)</label>
                <label style="color: var(--danger-color);"><input type="checkbox" id="reset-stores-checkbox"> ลบร้านค้าทั้งหมด (Stores)</label>
            </div>
            <div id="reset-modal-actions">
                <button type="button" id="cancel-reset-btn" style="background-color: #6c757d;">ยกเลิก</button>
                <button type="button" id="confirm-selective-reset-btn" class="danger">ยืนยันการรีเซ็ต</button>
            </div>
        </div>
    </div>

    <div id="print-container"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence, collection } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyASOj70VlF3cfbqDDEm0l6kp6DmFvWXmVM",
  authDomain: "salejuck.firebaseapp.com",
  databaseURL: "https://salejuck-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "salejuck",
  storageBucket: "salejuck.firebasestorage.app",
  messagingSenderId: "88647143808",
  appId: "1:88647143808:web:c717bfe69a8ac565a7b165"
};

        window._initFirebaseModule = async function() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // ปิด Persistence ชั่วคราวถ้ามันทำให้การ sync ช้าในบางเครื่อง
                // แต่ถ้าต้องการใช้ offline ให้เปิดไว้
                try { 
                    await enableIndexedDbPersistence(db);
                    console.log('Firebase Persistence Enabled'); 
                } catch (err) {
                    console.log('Persistence Error/Already Enabled:', err.code);
                }

                await signInAnonymously(auth);
                return { app, auth, db };
            } catch (e) {
                console.error("Firebase Init Error:", e);
                return null;
            }
        };

        window.firebase_tools_getDoc = async function(db, collectionName, docId) {
            try {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return { exists: true, data: docSnap.data() };
                } else {
                    return { exists: false, data: null };
                }
            } catch (e) {
                console.error("Error getting document:", e);
                throw e;
            }
        };

        window.firebase_tools_setDoc = async function(db, collectionName, docId, data, merge = false) {
            try {
                const docRef = doc(db, collectionName, docId);
                await setDoc(docRef, data, { merge: merge }); 
            } catch (e) {
                console.error("Error writing document:", e);
                throw e;
            }
        };

        window.firebase_tools_onSnapshot = function(db, collectionName, docId, callback) {
            const docRef = doc(db, collectionName, docId);
            // includeMetadataChanges: true เพื่อให้รู้ว่าข้อมูลมาจาก local หรือ server
            return onSnapshot(docRef, { includeMetadataChanges: true }, (doc) => {
                if(doc.exists()) callback({ data: doc.data(), metadata: doc.metadata });
            });
        };
    </script>
    <script src="script.js"></script>
</body>
</html>